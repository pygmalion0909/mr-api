<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mr.mr_api.user.repository.RsvHsBasRepository">

  <select id="getRsvCompletedItems" resultType="com.mr.mr_api.user.entity.rsv.RsvHsBasItemEnt">
    SELECT
      `sq1`.*
      ,`itb`.`per_tm`
    FROM
    (
      SELECT 
        `rhb`.`id`
        ,`rhb`.`store_id`
        ,`rhb`.`item_id`
        ,`rhb`.`user_id`
        ,`rhb`.`rsv_tms`
        ,`rhb`.`day_cd`
        ,`rhb`.`rsv_per`
        ,`rhb`.`status_cd`
        ,`rhb`.`create_tms`
        ,`rhb`.`modify_tms`
        ,SUM(`rhb`.`rsv_per`) AS `rsv_per_sum`
      FROM
        tb_rsv_hs_bas `rhb`
      WHERE
        `rhb`.`rsv_tms` = #{rsvTms}
        AND `rhb`.`day_cd` = #{dayCd}
        AND `rhb`.`status_cd` = #{statusCd}
      GROUP BY `rhb`.`item_id`
    ) `sq1`
    LEFT JOIN tb_item_bas `itb` ON `sq1`.`item_id` = `itb`.`id`
    WHERE `sq1`.`rsv_per_sum` = `itb`.`per_tm`
  </select>

  <select id="getListMonth" resultType="com.mr.mr_api.user.entity.rsv.RsvHsBasMthEnt">
    SELECT
      `sq1`.`store_id`
      ,DATE_FORMAT(`sq1`.`rsv_tms`, "%Y-%m-%d") AS `rsv_dt`
      ,`sq1`.`day_cd`
      ,COUNT(`sq1`.`rsv_tms`) AS `count_time`
    FROM (
      SELECT
        `rhb`.`store_id`
        ,`rhb`.`rsv_tms`
        ,`rhb`.`day_cd` 
      FROM tb_rsv_hs_bas `rhb`
      WHERE 
        DATE_FORMAT(`rhb`.`rsv_tms`, "%Y-%m") = #{yearMth}
        AND `rhb`.`status_cd` = #{statusCd}
      GROUP BY DATE_FORMAT(`rhb`.`rsv_tms`, "%Y-%m-%d %H:%i:%s")
    ) `sq1`
    GROUP BY DATE_FORMAT(`sq1`.`rsv_tms`, "%Y-%m-%d")
  </select>

  <select id="getRsvSumPer" resultType="String">
    SELECT
      SUM(`rhb`.`rsv_per`) AS `sum_rsv_per` 
    FROM tb_rsv_hs_bas `rhb`
    WHERE
      `rhb`.`day_cd` = #{dayCd}
      AND `rhb`.`rsv_tms` = #{rsvTms}
      AND `rhb`.`store_id` = #{storeId}
      AND `rhb`.`item_id` = #{itemId}
      AND `rhb`.`status_cd`= #{statusCd}
    GROUP BY `rhb`.`rsv_tms`
  </select>

  <insert id="register">
    INSERT INTO tb_rsv_hs_bas
    (
      store_id
      ,user_id
      ,item_id
      ,rsv_tms
      ,day_cd
      ,rsv_per
      ,status_cd
      ,create_tms
    )
    VALUES
    (
      #{storeId}
      ,#{userId}
      ,#{itemId}
      ,#{rsvTms}
      ,#{dayCd}
      ,#{rsvPer}
      ,#{statusCd}
      ,NOW()
    )
  </insert>

</mapper>